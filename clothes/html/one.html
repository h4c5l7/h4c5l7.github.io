<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>一区</title>
		<script type="text/javascript" src="js/jquery-1.11.2.js" ></script>
		<script type="text/javascript" src="js/jquery.form.js" ></script>
		<link rel="stylesheet" href="css/oper.css" />
		<style>
			*{
				padding: 0;
				margin: 0;
				font-family: "microsoft yahei";
				
			}
			html,body{
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			#one_table{
				width: 65%;
				height: 100%;
				padding: 20px;
				box-sizing: border-box;
				float: left;
			}
			#one_table tbody{
				background-color: #B3EE3A;
				height: 100%;
			}
			#one_table tr td{
				text-align: center;
				vertical-align: top;
				border: 1px solid #000;
			}
			#one_table tr:nth-child(5) td:nth-child(1){
				font-size: 2em;
				line-height: 2em;
				font-weight: bolder;
			}
			.orderStyle{
			    display: inline-block;
				border: 1px solid #333;
        		margin-left: 5px;
			    margin-top: 5px;
			    padding: 5px;
			}
			.orderBox{
			}
		</style>
	</head>
	<body>
		<table id="one_table">
			<tbody>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
				<tr style="height: 14.28%;"></tr>
			</tbody>
		</table>
		<form id="oneForm" method="post" action="pullIn_post">
			<ul>
				<li class="search_li">
					<h3>查询</h3>
					<p>
						<label>订单编号</label>
						<input type="text" id="search_orderNum" name="search_orderNum"/>
						<input id="searchBtn" type="button" value="查询订单">
					</p>
				</li>
				<li class="into_li">
					<h3>入库</h3>
					<ul>
						<li>
							<label>订单编号</label>
							<input type="text" id="orderNum" name="orderNum"/>
							<input type="submit" id="pullInStorageBtn" value="入库"/>
						</li>
						<li>
							<label>存放位置</label>
							<select id="store_id" name="store_id"></select>
						</li>
						<li>
							<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价格</label>
							<input type="text" id="price" name="price"/>
						</li>
						<li>
							<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;备注</label>
							<textarea id="remark" name="remark"></textarea>
						</li>
					</ul>
				</li>
			</ul>
		</form>
		<style>
			#show_button{
				width: 100px;
				height: 30px;
				font:100 14px "微软雅黑";
				border:1px solid #666;
				border-radius:4px;
				display:none;
				position:absolute;
				top:0;
				left:0;
				background:#fff;
				z-index:666;
				text-align: center;
    			line-height: 30px;
			}
			#show_button:hover{
				background:#F8F8FF;
				cursor:pointer;
			}
		</style>
		<div id="show_button">存入订单</div>
	</body>
	<script>
		$(document).ready(function() {
			
			var onePage = {
			initPage:function(){
				var array0=[1];
				var array1=[2,3,4,5,6,7,8,9,10,11,12];
				var array2=[13,14,15,16,17,18,19,20,21,22,23];
				var array3=[24,25,26,27,28,29];
				var array4=['一区',30,31,32,33,34];
				var array5=[35,36,37,38,39];
				var array6=[40,41,42,43,44,45,46,47,48,49,50];
				for(let i=1;i<=50;i++){
					$("#store_id").append("<option value='one_"+i+"'>"+i+"</option");
				}
				var $tbody = $("#one_table tbody");
				for(let i=0;i<array0.length;i++){
					$tbody.find("tr").eq(0).append("<td colspan='11' value='one_"+array0[i]+"'>"+array0[i]+"<br/></td>");
				}
				for(let i=0;i<array1.length;i++){
					$tbody.find("tr").eq(1).append("<td value='one_"+array1[i]+"' width='9.09%' height='14.28%'>"+array1[i]+"<br/><div class='orderBox'></div></td>");
				}
				for(let i=0;i<array2.length;i++){
					$tbody.find("tr").eq(2).append("<td value='one_"+array2[i]+"' width='9.09%' >"+array2[i]+"<br/></td>");
				}
				for(let i=0;i<array3.length;i++){
					if(i==0){
						$tbody.find("tr").eq(3).append("<td colspan='6' value='one_"+array3[i]+"'>"+array3[i]+"<br/></td>");
					}else{
						$tbody.find("tr").eq(3).append("<td value='one_"+array3[i]+"'>"+array3[i]+"<br/></td>");
					}
					
				}
				for(let i=0;i<array4.length;i++){
					if(i == 0){
						$tbody.find("tr").eq(4).append("<td rowspan='2' colspan='6' style='background:#ccc;vertical-align: middle;' value='one_"+array4[i]+"'>"+array4[i]+"<br/></td>");
					}else{
						$tbody.find("tr").eq(4).append("<td value='one_"+array4[i]+"'>"+array4[i]+"<br/></td>");
					}
				}
				for(let i=0;i<array5.length;i++){
					$tbody.find("tr").eq(5).append("<td value='one_"+array5[i]+"'>"+array5[i]+"<br/></td>");
				}
				for(let i=0;i<array6.length;i++){
					$tbody.find("tr").eq(6).append("<td value='one_"+array6[i]+"'>"+array6[i]+"<br/><div class='order-box'></div></td>");
				}
				$.ajax({
					type:"post",
					url:"/searchForTd",
					async:true,
					data:"area=one",
					success:function(result){
						$(JSON.parse(result)).each(function(index,element){
							$tbody.find("tr td[value='"+element.store_id+"'] .orderBox").append("<div class='orderStyle'>"+element._id+"</div>");
						})
					}
				});
			},
			//校验
			verifyFun:function(){
				var orderNum = $("#orderNum").val();
				if(orderNum == false){
					alert("请输入订单编号！");
					return false;
				}
				var re2 =  /^[0-9a-zA-Z]*$/g;
				if(!re2.test(orderNum)){
					alert("订单编号只能输入数字和字母");
					return false;
				}
				var re = /^\d+(?=\.{0,1}\d+$|$)/;
				var price =  $("#price").val();
				if(!re.test(price)){
					alert("价格请输入正确的数字");
					return false;
				}
				return true;
			},
			//初始化事件
			initEvent:function(){
				_this = this;
				//td的点击事件
				$("body").on("click",function(e){
					var tdText = $(e.target).attr("value");
					if(e.target.tagName == 'TD' && e.target.innerText != '一区'){
						var clientX = e.clientX;
						var clientY = e.clientY;
						$("#show_button").css("left",clientX).css("top",clientY);
						$("#show_button").show();
						$("#store_id").find("option[value='"+tdText+"']").prop("selected",true);
						$("body").on("click","#show_button",function(e2){
							$("#orderNum").focus();
							$("#show_button").hide();
						})
					}else{
						$("#show_button").hide();
					}
				})
				//出库
				$("body").on("click",".orderStyle",function(e){
					var e=window.event||e;
    				e.stopPropagation();
					var search_orderNum = $(this).html();
					if(confirm("订单"+search_orderNum+"是否需要出库？")){
						//确认出库
						//让 status变为2，
						$.ajax({
							url:"/pullOut_post",
							type:"POST",
							data:"_id="+search_orderNum,
							success:function(result1){
								$("div:contains('"+search_orderNum+"')").remove();
								alert(result1);
							}
						})
					}
				})
				//查询订单
				$("#searchBtn").on('click',function(){
					var search_orderNum = $("#search_orderNum").val();
					if(search_orderNum == ""){
						alert("请输入订单编号查询！");
						return false;
					}
					$.ajax({
						url:"/search_post",
						type:"POST",
						data:"search_orderNum="+search_orderNum,
						success:function(result){
							if(result === false){
								alert("在仓库内没有查询到该订单！");
							}else{
								//出库
								param = JSON.parse(result);
								var tipMess = "订单"+param._id+"存放在"+param.store_id+"号仓库中，是否需要出库？";
								if(confirm(tipMess)){
									//确认出库
									//让 status变为2，
									$.ajax({
										url:"/pullOut_post",
										type:"POST",
										data:"_id="+search_orderNum,
										success:function(result1){
											$("div:contains('"+param._id+"')").remove();
											alert(result1);
										}
									})
								}
							}
						}
					})
				})
			}
			
		}
		onePage.initPage();
		onePage.initEvent();
	    var options = {
			success:function(data,statusText){
				if(data == 0){
					alert("该订单号已使用过！");
				}
				if(data == 1){
					var orderNum = $("#orderNum").val();
					var store_id = $("#store_id").val();
					$("table tr td[value='"+store_id+"']").append("<div class='orderStyle'>"+orderNum+"</div>");
					alert("入库成功！");
				}
			},
			error:function(data){
				alert(data.message);
			},
			beforeSubmit:function(arr,$form,options){
				return onePage.verifyFun();
			}
		};
	    // bind form using 'ajaxForm' 
	    $('#oneForm').ajaxForm(options).submit(function(){return false;}); 
	 });
		
	</script>
</html>
